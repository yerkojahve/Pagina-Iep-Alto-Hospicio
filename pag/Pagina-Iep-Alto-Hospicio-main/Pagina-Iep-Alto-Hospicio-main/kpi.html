<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Dashboard — Concentración Jóvenes AH 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --bg:#0b1020; --card:#111a33; --txt:#e5ecff; --muted:#b7c3ea; --accent:#38bdf8; }
    body{background:linear-gradient(120deg,#0b1020,#1b2a4b); color:var(--txt);}
    .kpi-card{background:var(--card); border:1px solid rgba(255,255,255,.12); border-radius:1rem;}
    .kpi-title{font-size:.9rem; color:var(--muted);}
    .kpi-value{font-size:2rem; font-weight:700; color:var(--accent);}
    table{color:var(--txt);}
    .table thead th{color:var(--muted); border-color:rgba(255,255,255,.1);}
    .table td, .table th{border-color:rgba(255,255,255,.06);}
    a, a:hover{color:var(--accent);}
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="mb-4">
      <h1 class="h3 mb-1">Concentración Jóvenes AH 2025 — Dashboard</h1>
      <div id="updated_at" class="text-secondary small"></div>
    </header>

    <!-- KPIs -->
    <div class="row g-3" id="kpis">
      <div class="col-6 col-md-3">
        <div class="p-3 kpi-card">
          <div class="kpi-title">Personas</div>
          <div id="kpi_asistentes" class="kpi-value">—</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="p-3 kpi-card">
          <div class="kpi-title">Familias</div>
          <div id="kpi_familias" class="kpi-value">—</div>
          <div class="small text-secondary">Capacidad total: <span id="kpi_capacidad">—</span></div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="p-3 kpi-card">
          <div class="kpi-title">Iglesias</div>
          <div id="kpi_iglesias" class="kpi-value">—</div>
          <div class="small text-secondary">Top en listado</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="p-3 kpi-card">
          <div class="kpi-title">Organizadores</div>
          <div id="kpi_organizadores" class="kpi-value">—</div>
        </div>
      </div>
    </div>

    <!-- Familias -->
    <section class="mt-4">
      <h2 class="h5">Familias alojadoras</h2>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Familia</th>
              <th class="text-end">Capacidad</th>
              <th class="text-end">Ocupados</th>
              <th class="text-end">Disponibles</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tbody_familias"></tbody>
        </table>
      </div>
      <div class="small text-secondary">
        Cupos libres totales: <span id="kpi_cupos">—</span> · Ocupación total: <span id="kpi_ocupacion">—</span>
      </div>
    </section>

    <!-- Personas -->
    <section class="mt-4">
      <h2 class="h5">Personas</h2>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Iglesia</th>
              <th>Familia</th>
              <th>Cargo</th>
            </tr>
          </thead>
          <tbody id="tbody_personas"></tbody>
        </table>
      </div>
    </section>

    <!-- Iglesias -->
    <section class="mt-4">
      <h2 class="h5">Iglesias</h2>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Contacto</th>
              <th>Teléfono</th>
              <th>Dirección</th>
            </tr>
          </thead>
          <tbody id="tbody_iglesias"></tbody>
        </table>
      </div>
    </section>

    <!-- Organizadores -->
    <section class="mt-4 mb-5">
      <h2 class="h5">Organizadores</h2>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Rol</th>
              <th>Iglesia</th>
              <th>Contacto</th>
              <th>Turno</th>
            </tr>
          </thead>
          <tbody id="tbody_organizadores"></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
  const BUST = String(Date.now());

  // Construye base "./data/" relativa a donde está kpi.html
  const DATA_BASE_REL = new URL('./data/', window.location.href).href;

  // Si estás abriendo el archivo con doble clic (file://), habilitamos un fallback al dominio
  const HOST_BASE = "https://iepaltohospicio.site/data/";

  function urlFor(file){
    // siempre probamos primero la relativa; si estás en file:// se intentará igual
    return [
      DATA_BASE_REL + file + "?" + BUST,   // ./data/file.json
      HOST_BASE + file + "?" + BUST        // https://iepaltohospicio.site/data/file.json (fallback)
    ];
  }

  // fetch con fallback: intenta la 1ª URL; si falla, intenta la 2ª
  async function safeFetchMulti(files){
    for(const u of files){
      try{
        const r = await fetch(u, { cache: "no-store" });
        if(r.ok) return await r.json();
      }catch(_) { /* sigue probando */ }
    }
    return null;
  }

  async function loadAll(){
    const [dash, personas, full] = await Promise.all([
      safeFetchMulti(urlFor("dashboard.json")),
      safeFetchMulti(urlFor("personas.json")),
      safeFetchMulti(urlFor("full_dump.json")),
    ]);

    console.log({dash, personas, full}); // debug útil

    const setText = (id, v)=> (document.getElementById(id).textContent = (v ?? "—"));
    const td = (t, cls)=>{ const el=document.createElement("td"); el.textContent=t??""; if(cls) el.className=cls; return el; };

    // KPIs
    if(dash?.totales){
      setText("kpi_asistentes", dash.totales.asistentes);
      setText("kpi_familias",   dash.totales.familias);
      setText("kpi_iglesias",   dash.totales.iglesias);
      setText("kpi_capacidad",  dash.totales.capacidad_total ?? 0);
      setText("kpi_cupos",      dash.totales.cupos_libres_total ?? 0);
      setText("kpi_ocupacion",  dash.totales.ocupacion_total ?? 0);
      const orgs = (full?.organizadores?.length ?? dash?.totales?.organizadores ?? 0);
      setText("kpi_organizadores", orgs);
    }
    if(dash?.updated_at){
      setText("updated_at", `Actualizado: ${dash.updated_at}`);
    }

    // Familias
    const tbodyFamilias = document.getElementById("tbody_familias");
    (dash?.familias ?? []).forEach(f=>{
      const tr = document.createElement("tr");
      tr.appendChild(td(f.familia));
      tr.appendChild(td(f.capacidad, "text-end"));
      tr.appendChild(td(f.ocupados, "text-end"));
      tr.appendChild(td(f.disponibles ?? "—", "text-end"));
      tr.appendChild(td(f.estado));
      tbodyFamilias.appendChild(tr);
    });

    // Personas
    const tbodyPersonas = document.getElementById("tbody_personas");
    (personas ?? []).forEach(p=>{
      const tr = document.createElement("tr");
      tr.appendChild(td(p.nombre));
      tr.appendChild(td(p.iglesia));
      tr.appendChild(td(p.familia_alojadora));
      tr.appendChild(td(p.cargo));
      tbodyPersonas.appendChild(tr);
    });

    // Iglesias
    const tbodyIglesias = document.getElementById("tbody_iglesias");
    (full?.iglesias ?? []).forEach(i=>{
      const tr = document.createElement("tr");
      tr.appendChild(td(i.nombre));
      tr.appendChild(td(i.contacto));
      tr.appendChild(td(i.telefono));
      tr.appendChild(td(i.direccion));
      tbodyIglesias.appendChild(tr);
    });

    // Organizadores
    const tbodyOrganizadores = document.getElementById("tbody_organizadores");
    (full?.organizadores ?? []).forEach(o=>{
      const tr = document.createElement("tr");
      tr.appendChild(td(o.nombre));
      tr.appendChild(td(o.rol));
      tr.appendChild(td(o.iglesia));
      tr.appendChild(td(o.contacto));
      tr.appendChild(td(o.turno));
      tbodyOrganizadores.appendChild(tr);
    });
  }

  (async ()=>{ await loadAll(); })();
</script>

</body>
</html>
